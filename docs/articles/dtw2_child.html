<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title> • tsrecipes</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="">
<meta property="og:description" content="tsrecipes">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">tsrecipes</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/base-example.html">base-example</a>
    </li>
    <li>
      <a href="../articles/benchmarking-dct.html">benchmarking-dct</a>
    </li>
    <li>
      <a href="../articles/dct-explanation_child.html">UNKNOWN TITLE</a>
    </li>
    <li>
      <a href="../articles/dtw2.html">dtw2</a>
    </li>
    <li>
      <a href="../articles/dtw2_child.html">UNKNOWN TITLE</a>
    </li>
    <li>
      <a href="../articles/tune.html">tune</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/tmastny/tsrecipes/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="dtw2_child_files/header-attrs-2.3/header-attrs.js"></script><script src="dtw2_child_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip></h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tmastny/tsrecipes/blob/master/vignettes/dtw2_child.Rmd"><code>vignettes/dtw2_child.Rmd</code></a></small>
      <div class="hidden name"><code>dtw2_child.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>Working with a <em>set</em> of time series measuring related observations requires a different set of tools compared to analyzing or forecasting a single time series.</p>
<p>If you want to cluster time series into groups with similar behaviors, one option is feature extraction: statistical summaries that characterize some feature of the time series, such as min, max, or spectral density. The <a href="https://feasts.tidyverts.org/index.html">feasts</a> R package and the Python package <a href="https://github.com/blue-yonder/tsfresh">tsfresh</a> provide tools to make this easier.</p>
<p>Why not cluster on the time series directly? Standard methods don’t work as well, and can produce clusters that miss structure you can visually identify as “similar”.</p>
<p>Dynamic time warping is method that aligns with intuitive notions of time series similarity. To show how it works, I’ll walk through</p>
<ol style="list-style-type: decimal">
<li><p>how standard distance metrics fail to create useful time series clusters</p></li>
<li><p>dynamic time warping distance as a method for similarity</p></li>
<li><p>clustering similar time series</p></li>
</ol>
</div>
<div id="distance-metrics" class="section level2">
<h2 class="hasAnchor">
<a href="#distance-metrics" class="anchor"></a>Distance Metrics</h2>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tsrecipes</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tidyverse</span>)</pre></body></html></div>
<pre><code>## ── Attaching packages ────────────────────────────────────────────────── tidyverse 1.2.1 ──</code></pre>
<pre><code>## ✓ ggplot2 3.3.2     ✓ purrr   0.3.4
## ✓ tibble  3.0.3     ✓ dplyr   1.0.0
## ✓ tidyr   1.1.0     ✓ stringr 1.4.0
## ✓ readr   1.3.1     ✓ forcats 0.4.0</code></pre>
<pre><code>## ── Conflicts ───────────────────────────────────────────────────── tidyverse_conflicts() ──
## x dplyr::filter() masks stats::filter()
## x dplyr::lag()    masks stats::lag()</code></pre>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">dtwclust</span>)</pre></body></html></div>
<pre><code>## Loading required package: proxy</code></pre>
<pre><code>## 
## Attaching package: 'proxy'</code></pre>
<pre><code>## The following objects are masked from 'package:stats':
## 
##     as.dist, dist</code></pre>
<pre><code>## The following object is masked from 'package:base':
## 
##     as.matrix</code></pre>
<pre><code>## Loading required package: dtw</code></pre>
<pre><code>## Loaded dtw v1.21-3. See ?dtw for help, citation("dtw") for use in publication.</code></pre>
<pre><code>## dtwclust:
## Setting random number generator to L'Ecuyer-CMRG (see RNGkind()).
## To read the included vignettes type: browseVignettes("dtwclust").
## See news(package = "dtwclust") after package updates.</code></pre>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">patchwork</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">recipes</span>)</pre></body></html></div>
<pre><code>## 
## Attaching package: 'recipes'</code></pre>
<pre><code>## The following object is masked from 'package:stringr':
## 
##     fixed</code></pre>
<pre><code>## The following object is masked from 'package:stats':
## 
##     step</code></pre>
<p>To cluster, we need to measure the distance between every member of the group.<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> Typically we think of <a href="https://en.wikipedia.org/wiki/Euclidean_distance#:~:text=In%20mathematics%2C%20the%20Euclidean%20distance,metric%20as%20the%20Pythagorean%20metric.">Euclidean distance</a>: the length of a straight line between two points.</p>
<p>This distance pops up all the time in data science, usually in Mean Squared Error (MSE) or it’s counterpart Root Mean Squared Error (RMSE). It’s used to measure regression error in machine learning, and assess the accuracy of a <a href="https://otexts.com/fpp3/accuracy.html">time series forecast</a>.</p>
<pre><code>## ── Attaching packages ───────────────────────────────────────────────────────── fpp3 0.3 ──</code></pre>
<pre><code>## ✓ lubridate   1.7.9          ✓ feasts      0.1.4     
## ✓ tsibble     0.9.2          ✓ fable       0.1.1.9000
## ✓ tsibbledata 0.2.0</code></pre>
<pre><code>## ── Conflicts ──────────────────────────────────────────────────────────── fpp3_conflicts ──
## x lubridate::date()   masks base::date()
## x dplyr::filter()     masks stats::filter()
## x tsibble::interval() masks lubridate::interval()
## x dplyr::lag()        masks stats::lag()</code></pre>
<pre><code>## Plot variable not specified, automatically selected `.vars = Beer`</code></pre>
<p><img src="dtw2_child_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<p>To evaluate the fit of the forecast to the actual data, you can calculate the Euclidean distance between the corresponding points in the time series and the forecasts. The smaller the distance, the better the forecast: the more <em>similar</em> the two series are.</p>
<p>A straight line between two points isn’t always the possible. In a city grid, we are constrained by the blocks. In this situation, the distance between two points is called the <a href="https://en.wikipedia.org/wiki/Taxicab_geometry">Manhattan distance</a>.</p>
<div class="sourceCode" id="cb21"><html><body><pre class="r"><span class="kw pkg">knitr</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/include_graphics.html">include_graphics</a></span>(<span class="st">"283px-Manhattan_distance.svg.png"</span>)</pre></body></html></div>
<p><img src="283px-Manhattan_distance.svg.png" width="142"></p>
<p>Time series also need a special distance metric. The most common is called Dynamic Time Warping.</p>
<div id="time-series-distance" class="section level3">
<h3 class="hasAnchor">
<a href="#time-series-distance" class="anchor"></a>Time Series Distance</h3>
<p>Plotted below are three time series. I’ve plotted blue and green to both overlap red. Is blue or green more similar to red?</p>
<div class="sourceCode" id="cb22"><html><body><pre class="r"><span class="no">eth_sample</span> <span class="kw">&lt;-</span> <span class="no">ethanol</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">id</span> <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">53</span>))

<span class="no">eth_sample_unnested_trunc</span> <span class="kw">&lt;-</span> <span class="no">eth_sample</span> <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">n</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fl">1</span>:<span class="fl">1751</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">unnest</span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">ts</span>, <span class="no">n</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="fu">between</span>(<span class="no">n</span>, <span class="fl">500</span>, <span class="fl">1500</span>))

<span class="no">eth_sample_trunc</span> <span class="kw">&lt;-</span> <span class="no">eth_sample_unnested_trunc</span> <span class="kw">%&gt;%</span>
  <span class="fu">select</span>(-<span class="no">n</span>) <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="no">id</span>, <span class="no">class</span>) <span class="kw">%&gt;%</span>
  <span class="fu">summarise</span>(<span class="kw">ts</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">ts</span>), <span class="kw">.groups</span> <span class="kw">=</span> <span class="st">"drop"</span>)</pre></body></html></div>
<div class="sourceCode" id="cb23"><html><body><pre class="r"><span class="no">plot_overlap</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">ids</span>, <span class="no">x</span>) {
  <span class="no">group_colors</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">`1`</span> <span class="kw">=</span> <span class="st">"#F8766D"</span>, <span class="kw">`2`</span> <span class="kw">=</span> <span class="st">"#619CFF"</span>)
  <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span>(<span class="no">ids</span> <span class="kw">!=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fl">2</span>))) {
    <span class="no">group_colors</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">`1`</span> <span class="kw">=</span> <span class="st">"#F8766D"</span>, <span class="kw">`53`</span> <span class="kw">=</span> <span class="st">"#00BA38"</span>)
  }

  <span class="no">x</span> <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">id</span> <span class="kw">%in%</span> <span class="no">ids</span>) <span class="kw">%&gt;%</span>
    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="no">n</span>, <span class="no">ts</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">id</span>), <span class="kw">group</span> <span class="kw">=</span> <span class="no">id</span>)) +
    <span class="fu">geom_line</span>(<span class="kw">show.legend</span> <span class="kw">=</span> <span class="fl">FALSE</span>) +
    <span class="fu">scale_color_manual</span>(<span class="kw">values</span> <span class="kw">=</span> <span class="no">group_colors</span>) +
    <span class="fu">labs</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="kw">NULL</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="kw">NULL</span>)
}

<span class="no">plots</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fl">2</span>), <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fl">53</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">map</span>(<span class="no">plot_overlap</span>, <span class="no">eth_sample_unnested_trunc</span>)

<span class="no">plots</span><span class="kw">[[</span><span class="fl">1</span>]] / <span class="no">plots</span><span class="kw">[[</span><span class="fl">2</span>]]</pre></body></html></div>
<p><img src="dtw2_child_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>I think it’s blue: blue and red both has an early dip after 750. Around 1000 they both have a slim, deep trough. The major difference is that blue seems shifted to the left.</p>
<p>Green is all wrong: where red dips around 750, green has a bump. And the dip after 1000 is wider and shallower.</p>
<p>The Euclidean distance tells a different story. Red is actually closer to green, because it has a smaller distance metric (9.78 vs 9.83).</p>
<div class="sourceCode" id="cb24"><html><body><pre class="r"><span class="no">eth_sample</span>$<span class="no">ts</span> <span class="kw">%&gt;%</span>
  <span class="fu">set_names</span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"red"</span>, <span class="st">"blue"</span>, <span class="st">"green"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">simplify2array</a></span>() <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/dist.html">dist</a></span>()</pre></body></html></div>
<pre><code>##           red    blue
## blue  9.83149        
## green 9.78531 9.82103</code></pre>
</div>
</div>
<div id="dynamic-time-warping" class="section level2">
<h2 class="hasAnchor">
<a href="#dynamic-time-warping" class="anchor"></a>Dynamic Time Warping</h2>
<p>To capture our intuition about the similarity of red and blue, we need a new metric. This metric can’t simply measure the point-to-point distance between the series. As we saw, blue is shifted to the left of red, even though the shape is really similar. We need to <em>warp time</em> to account for this shift!</p>
<p>In the visualizations below<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>, you can see how dynamic time warping stretches (warps) time to match up nearby points.</p>
<div class="sourceCode" id="cb26"><html><body><pre class="r"><span class="no">plot_dtw</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">ts1</span>, <span class="no">ts2</span>, <span class="no">...</span>) {
  <span class="kw pkg">dtw</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/dtw/man/dtw.html">dtw</a></span>(<span class="no">ts1</span>, <span class="no">ts2</span>) <span class="kw">%&gt;%</span>
    <span class="kw pkg">dtw</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/dtw/man/dtwPlotTwoWay.html">dtwPlotTwoWay</a></span>(<span class="kw">xts</span> <span class="kw">=</span> <span class="no">ts1</span>, <span class="kw">yts</span> <span class="kw">=</span> <span class="no">ts2</span>, <span class="no">...</span>)
}

<span class="fu">plot_dtw</span>(
  <span class="no">eth_sample_trunc</span>$<span class="no">ts</span><span class="kw">[[</span><span class="fl">1</span>]], <span class="no">eth_sample_trunc</span>$<span class="no">ts</span><span class="kw">[[</span><span class="fl">2</span>]], <span class="kw">col</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"#F8766D"</span>, <span class="st">"#619CFF"</span>)
)</pre></body></html></div>
<p><img src="dtw2_child_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p>When comparing red to green below, there is a lot more warping going on to match up points (as measured by the light gray concentric lines between the series), so the time series are more dissimilar.</p>
<div class="sourceCode" id="cb27"><html><body><pre class="r"><span class="fu">plot_dtw</span>(
  <span class="no">eth_sample_trunc</span>$<span class="no">ts</span><span class="kw">[[</span><span class="fl">1</span>]], <span class="no">eth_sample_trunc</span>$<span class="no">ts</span><span class="kw">[[</span><span class="fl">3</span>]],
  <span class="kw">col</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"#F8766D"</span>, <span class="st">"#00BA38"</span>)
)</pre></body></html></div>
<p><img src="dtw2_child_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p>The dissimilarity between red and green is reflected when we calculate the dynamic time warping distance.</p>
<div class="sourceCode" id="cb28"><html><body><pre class="r"><span class="no">eth_sample</span>$<span class="no">ts</span> <span class="kw">%&gt;%</span>
  <span class="fu">set_names</span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"red"</span>, <span class="st">"blue"</span>, <span class="st">"green"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">simplify2array</a></span>() <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/dist.html">dist</a></span>(<span class="kw">method</span> <span class="kw">=</span> <span class="st">"DTW"</span>)</pre></body></html></div>
<pre><code>##            red     blue
## blue  28.26073         
## green 33.82476 31.50148</code></pre>
</div>
<div id="clustering-time-series" class="section level2">
<h2 class="hasAnchor">
<a href="#clustering-time-series" class="anchor"></a>Clustering Time Series</h2>
<p>Equipped with a measure of similarity, we can now attempt to cluster the time series. The time series studied in previous examples are part of a set of 504 time series, belonging to four classes.</p>
<p>I’ll use <code>step_dtw</code> from my tsrecipes package to cluster using the dynamic time warping similarity metric. <code>step_dtw</code> uses the excellent <a href="https://github.com/asardaes/dtwclust">dtwclust</a> package behind the scenes.</p>
<div class="sourceCode" id="cb30"><html><body><pre class="r"><span class="kw">if</span> (!<span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span>(<span class="st">"ethanol_distmat.RDS"</span>)) {
  <span class="no">prepped</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html">recipe</a></span>(<span class="no">ethanol</span>) <span class="kw">%&gt;%</span>
      <span class="fu"><a href="../reference/step_dtw.html">step_dtw</a></span>(<span class="no">ts</span>, <span class="kw">k</span> <span class="kw">=</span> <span class="fl">4</span>) <span class="kw">%&gt;%</span>
      <span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html">prep</a></span>()

   <span class="no">prepped</span>$<span class="no">steps</span><span class="kw">[[</span><span class="fl">1</span>]]$<span class="no">dtwclust</span>$<span class="no">ts</span>@<span class="kw">distmat</span> <span class="kw">%&gt;%</span>
     <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span>(<span class="st">"ethanol_distmat.RDS"</span>)
}

<span class="kw">if</span> (!<span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span>(<span class="st">"ethanol_clusters.RDS"</span>)) {
  <span class="no">ethanol_clusters</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html">recipe</a></span>(<span class="no">ethanol</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/step_dtw.html">step_dtw</a></span>(<span class="no">ts</span>, <span class="kw">k</span> <span class="kw">=</span> <span class="fl">4</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html">prep</a></span>() <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://recipes.tidymodels.org/reference/bake.html">bake</a></span>(<span class="no">ethanol</span>)

  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span>(<span class="no">ethanol_clusters</span>, <span class="st">"ethanol_clusters.RDS"</span>)
}

<span class="no">ethanol_clusters</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="st">"ethanol_clusters.RDS"</span>)</pre></body></html></div>
<div class="sourceCode" id="cb31"><html><body><pre class="r"><span class="no">ethanol_distmat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="st">"ethanol_distmat.RDS"</span>)</pre></body></html></div>
<p>With clustering, I think it’s important to evaluate the clusters using <em>objective</em> and <em>subjective</em> criteria.</p>
<p>Subjective criteria include</p>
<ul>
<li><p>visualizing the “shape” of time series within clusters to see if there is a pattern. If the shape isn’t obvious, you can try alternative methods or increase the number of clusters. Visualizations of noisy, high-frequency time series may not be useful. In this case, you may want to visualize smoothed trends of the cluster, rather than raw time series.</p></li>
<li><p>inspecting clusters for clutter: elements within the cluster that don’t seem to belong. This may indicate you need to increase the number of clusters.</p></li>
</ul>
<p>Objective criteria include</p>
<ul>
<li><p>checking the number of elements per cluster. Especially with hierarchical clustering, occasionally a cluster will have 90% of the data, which isn’t very useful.</p></li>
<li><p>evaluation against known classes. If working with unlabeled data, sometimes there may be a small portion of labeled data to evaluate against.</p></li>
<li><p>calculating cluster <a href="https://uc-r.github.io/hc_clustering#optimal">statistics</a>.</p></li>
</ul>
<p>Four classes are known ahead of time, so it seems reasonable to start with four clusters.</p>
<p>I always start with visualizing the time series within each cluster.</p>
<div class="sourceCode" id="cb32"><html><body><pre class="r"><span class="no">ethanol_clusters</span> <span class="kw">%&gt;%</span>
  <span class="fu">rowwise</span>() <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">n</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fl">1</span>:<span class="fl">1751</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">ungroup</span>() <span class="kw">%&gt;%</span>
  <span class="fu">unnest</span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">ts</span>, <span class="no">n</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>() +
  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="no">n</span>, <span class="no">ts</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="no">class</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="no">id</span>), <span class="kw">show.legend</span> <span class="kw">=</span> <span class="fl">FALSE</span>) +
  <span class="fu">facet_wrap</span>(~<span class="no">dtwclust_ts</span>)</pre></body></html></div>
<p><img src="dtw2_child_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
<p>Visually, there are distinct shapes within each cluster. Clusters 2 and 3 both have a clear middle dip. Cluster 1 has very few wiggles on the right, and cluster 4 is almost its mirror image, with few wiggles on the left.</p>
<p>All clusters seem a little clutter: especially 1 and 4 with all the wiggles on the left and right respectively.</p>
<p>Comparing the “shape” of the clusters to the shape of the individual classes, there doesn’t seem to be a lot of obvious similarity.</p>
<div class="sourceCode" id="cb33"><html><body><pre class="r"><span class="no">ethanol_clusters</span> <span class="kw">%&gt;%</span>
  <span class="fu">rowwise</span>() <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">n</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fl">1</span>:<span class="fl">1751</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">ungroup</span>() <span class="kw">%&gt;%</span>
  <span class="fu">unnest</span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">ts</span>, <span class="no">n</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="no">n</span>, <span class="no">ts</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">dtwclust_ts</span>))) +
  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="kw">group</span> <span class="kw">=</span> <span class="no">id</span>), <span class="kw">show.legend</span> <span class="kw">=</span> <span class="fl">FALSE</span>) +
  <span class="fu">facet_wrap</span>(~<span class="no">class</span>)</pre></body></html></div>
<p><img src="dtw2_child_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<p>The actual classes of the time series do not visually group into distinct shapes, indicating to me there is a lot of variation within each class.</p>
<div class="sourceCode" id="cb34"><html><body><pre class="r"><span class="no">mm_model</span> <span class="kw">&lt;-</span> <span class="no">ethanol_clusters</span> <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">dtwclust_ts</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">dtwclust_ts</span>)) <span class="kw">%&gt;%</span>
  <span class="kw pkg">nnet</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/nnet/man/multinom.html">multinom</a></span>(<span class="no">class</span> ~ <span class="no">dtwclust_ts</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">.</span>)</pre></body></html></div>
<pre><code>## # weights:  20 (12 variable)
## initial  value 698.692358 
## iter  10 value 692.557559
## final  value 692.467993 
## converged</code></pre>
<p>Predicting the class based on the cluster is only 31% accurate. Better than random chance (25%), but still not great.</p>
<div class="sourceCode" id="cb36"><html><body><pre class="r"><span class="no">pred_eth</span> <span class="kw">&lt;-</span> <span class="no">ethanol_clusters</span> <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">dtwclust_ts</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">dtwclust_ts</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">pred</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">mm_model</span>, <span class="no">.</span>, <span class="kw">type</span> <span class="kw">=</span> <span class="st">"class"</span>))

<span class="no">pred_eth</span> <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="no">class</span>, <span class="no">pred</span>) <span class="kw">%&gt;%</span>
  <span class="fu">summarise</span>(<span class="kw">n</span> <span class="kw">=</span> <span class="fu">n</span>()) <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="kw">pred_correct</span> <span class="kw">=</span> <span class="no">class</span> <span class="kw">==</span> <span class="no">pred</span>) <span class="kw">%&gt;%</span>
  <span class="fu">summarise</span>(<span class="kw">n</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">n</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">percent</span> <span class="kw">=</span> <span class="no">n</span> / <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">n</span>))</pre></body></html></div>
<pre><code>## `summarise()` regrouping output by 'class' (override with `.groups` argument)</code></pre>
<pre><code>## `summarise()` ungrouping output (override with `.groups` argument)</code></pre>
<pre><code>## # A tibble: 2 x 3
##   pred_correct     n percent
##   &lt;lgl&gt;        &lt;int&gt;   &lt;dbl&gt;
## 1 FALSE          354   0.702
## 2 TRUE           150   0.298</code></pre>
<p>Based on this analysis, I bet the clustering will be more useful if there are more clusters. While each cluster has a unique shape, there is still a lot of clutter. Moreover, we see a large amount of variation within each class. There will need to be more clusters to capture that variation.</p>
</div>
<div id="todo" class="section level2">
<h2 class="hasAnchor">
<a href="#todo" class="anchor"></a>TODO</h2>
<p>One of the most expensive parts of <code>tsclust</code> is calculating the distance matrix. If we could presupply the distance matrix as an option to step_dtw (or another step entirely), then we could significantly speed up the process.</p>
<p>what about <code>step_proxy</code> and use different clustering methods against that?</p>
<div class="sourceCode" id="cb40"><html><body><pre class="r"><span class="kw">if</span> (!<span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span>(<span class="st">"ethanol_clusters8.RDS"</span>)) {
  <span class="no">ethanol_clusters8</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html">recipe</a></span>(<span class="no">ethanol</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/step_dtw.html">step_dtw</a></span>(<span class="no">ts</span>, <span class="kw">k</span> <span class="kw">=</span> <span class="fl">8</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html">prep</a></span>() <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://recipes.tidymodels.org/reference/bake.html">bake</a></span>(<span class="no">ethanol</span>)

  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span>(<span class="no">ethanol_clusters8</span>, <span class="st">"ethanol_clusters8.RDS"</span>)
}

<span class="no">ethanol_clusters8</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="st">"ethanol_clusters8.RDS"</span>)</pre></body></html></div>
<div class="sourceCode" id="cb41"><html><body><pre class="r"><span class="no">model8</span> <span class="kw">&lt;-</span> <span class="no">ethanol_clusters8</span> <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">dtwclust_ts</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">dtwclust_ts</span>)) <span class="kw">%&gt;%</span>
  <span class="kw pkg">nnet</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/nnet/man/multinom.html">multinom</a></span>(<span class="no">class</span> ~ <span class="no">dtwclust_ts</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">.</span>)</pre></body></html></div>
<pre><code>## # weights:  36 (24 variable)
## initial  value 698.692358 
## iter  10 value 681.029270
## iter  20 value 680.008252
## final  value 680.005159 
## converged</code></pre>
<p>With 8 clusters, there are more definition to the shapes, and a lot less clutter.</p>
<div class="sourceCode" id="cb43"><html><body><pre class="r"><span class="no">ethanol_clusters8</span> <span class="kw">%&gt;%</span>
  <span class="fu">rowwise</span>() <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">n</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fl">1</span>:<span class="fl">1751</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">ungroup</span>() <span class="kw">%&gt;%</span>
  <span class="fu">unnest</span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">ts</span>, <span class="no">n</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>() +
  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="no">n</span>, <span class="no">ts</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="no">class</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="no">id</span>), <span class="kw">show.legend</span> <span class="kw">=</span> <span class="fl">FALSE</span>) +
  <span class="fu">facet_wrap</span>(~<span class="no">dtwclust_ts</span>)</pre></body></html></div>
<p><img src="dtw2_child_files/figure-html/unnamed-chunk-18-1.png" width="700"></p>
<div class="sourceCode" id="cb44"><html><body><pre class="r"><span class="no">pred_eth</span> <span class="kw">&lt;-</span> <span class="no">ethanol_clusters8</span> <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">dtwclust_ts</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">dtwclust_ts</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">pred</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">model8</span>, <span class="no">.</span>, <span class="kw">type</span> <span class="kw">=</span> <span class="st">"class"</span>))

<span class="no">pred_eth</span> <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="no">class</span>, <span class="no">pred</span>) <span class="kw">%&gt;%</span>
  <span class="fu">summarise</span>(<span class="kw">n</span> <span class="kw">=</span> <span class="fu">n</span>()) <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="kw">pred_correct</span> <span class="kw">=</span> <span class="no">class</span> <span class="kw">==</span> <span class="no">pred</span>) <span class="kw">%&gt;%</span>
  <span class="fu">summarise</span>(<span class="kw">n</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">n</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">percent</span> <span class="kw">=</span> <span class="no">n</span> / <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">n</span>))</pre></body></html></div>
<pre><code>## `summarise()` regrouping output by 'class' (override with `.groups` argument)</code></pre>
<pre><code>## `summarise()` ungrouping output (override with `.groups` argument)</code></pre>
<pre><code>## # A tibble: 2 x 3
##   pred_correct     n percent
##   &lt;lgl&gt;        &lt;int&gt;   &lt;dbl&gt;
## 1 FALSE          346   0.687
## 2 TRUE           158   0.313</code></pre>
<p>Additionally, there is a 3% increase in accuracy.</p>
<div id="additional-clusters" class="section level3">
<h3 class="hasAnchor">
<a href="#additional-clusters" class="anchor"></a>Additional Clusters</h3>
<p>You may have noticed that running <code>step_dtw</code> takes a long time. The bottleneck is calculating the dynamic time warping distance. Most implementations have a computational complexity of <span class="math inline">\(O(N^2)\)</span><a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a> to calculate the distance between two time series, and that calculation must happen between <em>every pair</em> of time series in the dataset to cluster.</p>
<p>Fortunately, the <code>dtwclust</code> interface lets you precompute the the similarity matrix and supply that to the cluster algorithms. Care must be taken here to avoid data leakage (see the section below).</p>
<div class="sourceCode" id="cb48"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/getwd.html">getwd</a></span>()</pre></body></html></div>
<pre><code>## [1] "/Users/Tim/rpackages/tsrecipes/vignettes"</code></pre>
<div class="sourceCode" id="cb50"><html><body><pre class="r"><span class="no">distmat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="st">"ethanol_distmat.RDS"</span>)</pre></body></html></div>
<div class="sourceCode" id="cb51"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tidymodels</span>)</pre></body></html></div>
<pre><code>## ── Attaching packages ───────────────────────────────────────────────── tidymodels 0.1.1 ──</code></pre>
<pre><code>## ✓ broom     0.7.0     ✓ rsample   0.0.7
## ✓ dials     0.0.8     ✓ tune      0.1.1
## ✓ infer     0.5.3     ✓ workflows 0.1.3
## ✓ modeldata 0.0.2     ✓ yardstick 0.0.7
## ✓ parsnip   0.1.3</code></pre>
<pre><code>## ── Conflicts ──────────────────────────────────────────────────── tidymodels_conflicts() ──
## x yardstick::accuracy() masks fabletools::accuracy()
## x scales::discard()     masks purrr::discard()
## x dplyr::filter()       masks stats::filter()
## x recipes::fixed()      masks stringr::fixed()
## x infer::generate()     masks fabletools::generate()
## x dplyr::lag()          masks stats::lag()
## x parsnip::null_model() masks fabletools::null_model()
## x yardstick::spec()     masks readr::spec()
## x recipes::step()       masks stats::step()</code></pre>
<div class="sourceCode" id="cb55"><html><body><pre class="r"><span class="no">dtw_options</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">control</span> <span class="kw">=</span> <span class="kw pkg">dtwclust</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/dtwclust/man/tsclust-controls.html">partitional_control</a></span>(<span class="kw">distmat</span> <span class="kw">=</span> <span class="no">distmat</span>))

<span class="co"># rec &lt;- recipe(</span>
<span class="co">#   ethanol, vars = names(ethanol), roles = c("id", "outcome", "input")</span>
<span class="co"># ) %&gt;%</span>
<span class="no">rec</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html">recipe</a></span>(<span class="no">ethanol</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://recipes.tidymodels.org/reference/roles.html">update_role</a></span>(<span class="fu">everything</span>(), <span class="kw">new_role</span> <span class="kw">=</span> <span class="st">"id"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://recipes.tidymodels.org/reference/roles.html">update_role</a></span>(<span class="no">class</span>, <span class="kw">new_role</span> <span class="kw">=</span> <span class="st">"outcome"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/step_dtw.html">step_dtw</a></span>(<span class="no">ts</span>, <span class="kw">k</span> <span class="kw">=</span> <span class="fu">tune</span>(), <span class="kw">options</span> <span class="kw">=</span> <span class="no">dtw_options</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_mutate_at.html">step_mutate_at</a></span>(<span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_predictors</a></span>(), <span class="kw">fn</span> <span class="kw">=</span> <span class="no">factor</span>)</pre></body></html></div>
<div class="sourceCode" id="cb56"><html><body><pre class="r"><span class="no">val</span> <span class="kw">&lt;-</span> <span class="fu">tibble</span>(
  <span class="kw">splits</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fu">make_splits</span>(
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">analysis</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="fl">504</span>, <span class="kw">assessment</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="fl">504</span>), <span class="kw">data</span> <span class="kw">=</span> <span class="no">ethanol</span>
  ))
) <span class="kw">%&gt;%</span>
  <span class="fu">new_rset</span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">id</span> <span class="kw">=</span> <span class="st">"validation"</span>), <span class="kw">subclass</span> <span class="kw">=</span> <span class="st">"rset"</span>)</pre></body></html></div>
<div class="sourceCode" id="cb57"><html><body><pre class="r"><span class="kw">if</span> (!<span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span>(<span class="st">"ethanol_tune_results.RDS"</span>)) {
  <span class="no">tune_results</span> <span class="kw">&lt;-</span> <span class="fu">workflow</span>() <span class="kw">%&gt;%</span>
    <span class="fu">add_model</span>(<span class="fu">multinom_reg</span>() <span class="kw">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"nnet"</span>)) <span class="kw">%&gt;%</span>
    <span class="fu">add_recipe</span>(<span class="no">rec</span>) <span class="kw">%&gt;%</span>
    <span class="fu">tune_grid</span>(
      <span class="kw">resamples</span> <span class="kw">=</span> <span class="no">val</span>,
      <span class="kw">grid</span> <span class="kw">=</span> <span class="fu">expand_grid</span>(<span class="kw">k</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">4</span>, <span class="fl">8</span>, <span class="fl">16</span>, <span class="fl">32</span>, <span class="fl">64</span>))
    )
  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span>(<span class="no">tune_results</span>, <span class="st">"ethanol_tune_results.RDS"</span>)
}

<span class="no">tune_results</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="st">"ethanol_tune_results.RDS"</span>)</pre></body></html></div>
<div class="sourceCode" id="cb58"><html><body><pre class="r"><span class="no">tune_results</span> <span class="kw">%&gt;%</span>
  <span class="fu">collect_metrics</span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">.metric</span> <span class="kw">==</span> <span class="st">"accuracy"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">select</span>(<span class="no">k</span>, <span class="no">mean</span>)</pre></body></html></div>
<pre><code>## # A tibble: 5 x 2
##       k  mean
##   &lt;dbl&gt; &lt;dbl&gt;
## 1     4 0.335
## 2     8 0.333
## 3    16 0.379
## 4    32 0.409
## 5    64 0.472</code></pre>
<p>Finding useful clusters requires setting enough distinct clusters.</p>
<p>But finding these clusters is also sensitive to the many options available in <code><a href="https://rdrr.io/pkg/dtwclust/man/tsclust.html">dtwclust::tsclust</a></code>.</p>
<p>Theoretically, you could tune across the number of clusters, as well as cluster (and distance methods).</p>
<p>It’s worth checking out <code><a href="https://rdrr.io/pkg/dtwclust/man/compare_clusterings.html">dtwclust::compare_clusterings</a></code> if you are interested in doing this. Right now it’s not supported in <code>step_dtw</code>. Clustering with <code>tsclust</code> takes a long time, and finding useful clusters can also be subjective.</p>
<p>I’d strongly recommend plotting clusters as a part of exploratory data analysis, rather than tuning blindly. Whether you doing a single clustering, or evaluating clusters objectively (scoring against classes) or subjectively (looking at the shape of clusters), you need to limit your explorations to the train set.</p>
<p>Just make sure you are still only using your training data, not your test data, when subjectively evaluating your clusters to avoid information leakage.</p>
<p>Be careful here: preprocessing, and even exploration on the training set can create <a href="http://www.feat.engineering/resampling.html">information leakage</a>, make your model appear more effective than it actually is.</p>
</div>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p> The UC Business Analytics <a href="https://uc-r.github.io/hc_clustering">R Programming Guide</a> has an excellent series on clustering, covering dissimilarity measures to the final clustering algorithms.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p><a href="https://www.r-bloggers.com/time-series-matching-with-dynamic-time-warping/" class="uri">https://www.r-bloggers.com/time-series-matching-with-dynamic-time-warping/</a><a href="#fnref2" class="footnote-back">↩︎</a></p></li>
<li id="fn3"><p> Some improvements can be made. <code>dtwclust</code> offers <code>dtw_basic</code> by default, which is significantly faster, with fewer features. And the <a href="https://dl.acm.org/doi/10.1145/3230734">theoretical</a> computational complexity is <span class="math inline">\(O(n^2/\log\log(n))\)</span>, although I don’t know if this has been implemented anywhere, or if its technically feasible to do so.<a href="#fnref3" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by First Last.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>

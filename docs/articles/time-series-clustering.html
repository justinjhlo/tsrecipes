<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Time series clustering with dynamic time warping • tsrecipes</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Time series clustering with dynamic time warping">
<meta property="og:description" content="tsrecipes">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">tsrecipes</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/base-example.html">base-example</a>
    </li>
    <li>
      <a href="../articles/benchmarking-dct.html">DCT Benchmarks</a>
    </li>
    <li>
      <a href="../articles/dct.html">What is the discrete cosine transform?</a>
    </li>
    <li>
      <a href="../articles/dtw.html">What is dynamic time warping?</a>
    </li>
    <li>
      <a href="../articles/time-series-clustering.html">Time series clustering with dynamic time warping</a>
    </li>
    <li>
      <a href="../articles/tune.html">tune</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/tmastny/tsrecipes/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="time-series-clustering_files/header-attrs-2.3/header-attrs.js"></script><script src="time-series-clustering_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Time series clustering with dynamic time warping</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tmastny/tsrecipes/blob/master/vignettes/time-series-clustering.Rmd"><code>vignettes/time-series-clustering.Rmd</code></a></small>
      <div class="hidden name"><code>time-series-clustering.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>Clustering is all about finding groups of similar observations based on their features. It’s used for</p>
<ul>
<li><p>exploratory data analysis. Especially useful for time series where you can cluster time series of similar “shape”.</p></li>
<li><p>labeling groups of time series.</p></li>
<li><p>feature engineering for time series classification, using the cluster as a feature. Can also be thought of as a dimensionality reduction technique.</p></li>
</ul>
<p>In this guide, I’ll show how you can use tsrecipes to cluster time series with dynamic time warping using the <a href="https://github.com/asardaes/dtwclust">dtwclust</a> R package<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>.</p>
<p>If you’d like to learn more about dynamic time warping, check out my <a href="">dynamic time warping</a> article.</p>
<p>For an introduction to clustering in general, UC Business Analytics Programming Guide has an excellent <a href="https://uc-r.github.io/kmeans_clustering">series</a> on clustering, introducing distance metrics and clustering techniques.</p>
</div>
<div id="evaluating-clusters" class="section level2">
<h2 class="hasAnchor">
<a href="#evaluating-clusters" class="anchor"></a>Evaluating Clusters</h2>
<p>With clustering, I think it’s important to evaluate the clusters using <em>objective</em> and <em>subjective</em> criteria.</p>
<p>Subjective criteria include</p>
<ul>
<li><p>visualizing the “shape” of time series within clusters to see if there is a pattern. If the shape isn’t obvious, you can try alternative methods or increase the number of clusters. Visualizations of noisy, high-frequency time series may not be useful. In this case, you may want to visualize smoothed trends of the cluster, rather than raw time series.</p></li>
<li><p>inspecting clusters for clutter: elements within the cluster that don’t seem to belong. This may indicate you need to increase the number of clusters.</p></li>
</ul>
<p>Objective criteria include</p>
<ul>
<li><p>checking the number of elements per cluster. Especially with hierarchical clustering, occasionally a cluster will have 90% of the data, which isn’t very useful.</p></li>
<li><p>calculating cluster statistics<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>.</p></li>
<li><p>evaluation against known classes, if available. This can even be helpful if only a small amount of labeled data is available.</p></li>
</ul>
<p>These principles will serve as a guide while clustering the <a href="http://www.timeseriesclassification.com/description.php?Dataset=EthanolLevel">Ethanol</a> data.</p>
</div>
<div id="ethanol" class="section level2">
<h2 class="hasAnchor">
<a href="#ethanol" class="anchor"></a>Ethanol</h2>
<p>The <code>ethanol</code> dataset has four classes, based on the levels of alcohol in the fuel.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tsrecipes</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tidyverse</span>)
<span class="co">#&gt; ── Attaching packages ─────────────────────────────────────────────────── tidyverse 1.2.1 ──</span>
<span class="co">#&gt; ✓ ggplot2 3.3.2     ✓ purrr   0.3.4</span>
<span class="co">#&gt; ✓ tibble  3.0.3     ✓ dplyr   1.0.0</span>
<span class="co">#&gt; ✓ tidyr   1.1.0     ✓ stringr 1.4.0</span>
<span class="co">#&gt; ✓ readr   1.3.1     ✓ forcats 0.4.0</span>
<span class="co">#&gt; ── Conflicts ────────────────────────────────────────────────────── tidyverse_conflicts() ──</span>
<span class="co">#&gt; x dplyr::filter() masks stats::filter()</span>
<span class="co">#&gt; x dplyr::lag()    masks stats::lag()</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">dtwclust</span>)
<span class="co">#&gt; Loading required package: proxy</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'proxy'</span>
<span class="co">#&gt; The following objects are masked from 'package:stats':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     as.dist, dist</span>
<span class="co">#&gt; The following object is masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     as.matrix</span>
<span class="co">#&gt; Loading required package: dtw</span>
<span class="co">#&gt; Loaded dtw v1.21-3. See ?dtw for help, citation("dtw") for use in publication.</span>
<span class="co">#&gt; dtwclust:</span>
<span class="co">#&gt; Setting random number generator to L'Ecuyer-CMRG (see RNGkind()).</span>
<span class="co">#&gt; To read the included vignettes type: browseVignettes("dtwclust").</span>
<span class="co">#&gt; See news(package = "dtwclust") after package updates.</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tidymodels</span>)
<span class="co">#&gt; ── Attaching packages ────────────────────────────────────────────────── tidymodels 0.1.1 ──</span>
<span class="co">#&gt; ✓ broom     0.7.0      ✓ recipes   0.1.13</span>
<span class="co">#&gt; ✓ dials     0.0.8      ✓ rsample   0.0.7 </span>
<span class="co">#&gt; ✓ infer     0.5.3      ✓ tune      0.1.1 </span>
<span class="co">#&gt; ✓ modeldata 0.0.2      ✓ workflows 0.1.3 </span>
<span class="co">#&gt; ✓ parsnip   0.1.3      ✓ yardstick 0.0.7</span>
<span class="co">#&gt; ── Conflicts ───────────────────────────────────────────────────── tidymodels_conflicts() ──</span>
<span class="co">#&gt; x scales::discard() masks purrr::discard()</span>
<span class="co">#&gt; x dplyr::filter()   masks stats::filter()</span>
<span class="co">#&gt; x recipes::fixed()  masks stringr::fixed()</span>
<span class="co">#&gt; x dplyr::lag()      masks stats::lag()</span>
<span class="co">#&gt; x yardstick::spec() masks readr::spec()</span>
<span class="co">#&gt; x recipes::step()   masks stats::step()</span></pre></body></html></div>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">ethanol</span> <span class="kw">%&gt;%</span>
  <span class="fu">rowwise</span>() <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">n</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fl">1</span>:<span class="fl">1751</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">ungroup</span>() <span class="kw">%&gt;%</span>
  <span class="fu">unnest</span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">ts</span>, <span class="no">n</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="no">n</span>, <span class="no">ts</span>)) +<span class="co">#, color = as.factor(id))) +</span>
  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="kw">group</span> <span class="kw">=</span> <span class="no">id</span>), <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.2</span>, <span class="kw">show.legend</span> <span class="kw">=</span> <span class="fl">FALSE</span>) +
  <span class="fu">facet_wrap</span>(~<span class="no">class</span>)</pre></body></html></div>
<p><img src="time-series-clustering_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<p>Visually, it’s hard for me to distinguish between classes. Maybe this indicates it will be hard to classify, or cluster into meaningful groups.</p>
<p>Four classes are known ahead of time, so it seems reasonable to start with four clusters.</p>
</div>
<div id="clustering-time-series" class="section level2">
<h2 class="hasAnchor">
<a href="#clustering-time-series" class="anchor"></a>Clustering time series</h2>
<p><code>step_dtw</code> clusters time series using the dynamic time warping similarity metric. Behind the scenes, <code>step_dtw</code> uses <a href="https://github.com/asardaes/dtwclust">dtwclust</a>. All it’s options are available, but we’ll stick with the defaults.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">prepped</span> <span class="kw">&lt;-</span> <span class="fu">recipe</span>(<span class="no">ethanol</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/step_dtw.html">step_dtw</a></span>(<span class="no">ts</span>, <span class="kw">k</span> <span class="kw">=</span> <span class="fl">4</span>) <span class="kw">%&gt;%</span>
  <span class="fu">prep</span>()

<span class="no">ethanol_clusters</span> <span class="kw">&lt;-</span> <span class="fu">bake</span>(<span class="no">prepped</span>, <span class="no">ethanol</span>)</pre></body></html></div>
<p>I always start with visualizing the time series within each cluster.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">ethanol_clusters</span> <span class="kw">%&gt;%</span>
  <span class="fu">rowwise</span>() <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">n</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fl">1</span>:<span class="fl">1751</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">ungroup</span>() <span class="kw">%&gt;%</span>
  <span class="fu">unnest</span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">ts</span>, <span class="no">n</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>() +
  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="no">n</span>, <span class="no">ts</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="no">id</span>), <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.2</span>, <span class="kw">show.legend</span> <span class="kw">=</span> <span class="fl">FALSE</span>) +
  <span class="fu">facet_wrap</span>(~<span class="no">dtwclust_ts</span>)</pre></body></html></div>
<p><img src="time-series-clustering_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p>I see distinct shapes within each cluster. Clusters 1 and 4 both have a clear middle dip, with different wiggles leading the the middle. Cluster 2 has very few wiggles on the right, and cluster 3 is sort of its mirror image, with few wiggles on the left.</p>
<p>All clusters seem a little cluttered: especially 2 and 3 with all the wiggles on the left and right respectively. Cluttered clusters mean we might get more logical groups if we increase the number of clusters.</p>
<p>Comparing the “shape” of the clusters to the shape of the individual classes from the previous section, there doesn’t seem to be a lot of obvious similarity. There’s a lot more variation and a lot less structure to the class plots.</p>
<div id="evaluation" class="section level3">
<h3 class="hasAnchor">
<a href="#evaluation" class="anchor"></a>Evaluation</h3>
<p>The clusters appear logically grouped, but they don’t necessarily look like the classes. Fortunately the <code>ethanol</code> dataset is labeled. We can test to see if the groups are predictive of the outcome.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">mm_model</span> <span class="kw">&lt;-</span> <span class="no">ethanol_clusters</span> <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">dtwclust_ts</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">dtwclust_ts</span>)) <span class="kw">%&gt;%</span>
  <span class="kw pkg">nnet</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/nnet/man/multinom.html">multinom</a></span>(<span class="no">class</span> ~ <span class="no">dtwclust_ts</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">.</span>)
<span class="co">#&gt; # weights:  20 (12 variable)</span>
<span class="co">#&gt; initial  value 698.692358 </span>
<span class="co">#&gt; iter  10 value 692.557559</span>
<span class="co">#&gt; final  value 692.467993 </span>
<span class="co">#&gt; converged</span></pre></body></html></div>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">pred_eth</span> <span class="kw">&lt;-</span> <span class="no">ethanol_clusters</span> <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">dtwclust_ts</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">dtwclust_ts</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">pred</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">mm_model</span>, <span class="no">.</span>, <span class="kw">type</span> <span class="kw">=</span> <span class="st">"class"</span>))

<span class="no">pred_eth</span> <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="no">class</span>, <span class="no">pred</span>) <span class="kw">%&gt;%</span>
  <span class="fu">summarise</span>(<span class="kw">n</span> <span class="kw">=</span> <span class="fu">n</span>()) <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="kw">pred_correct</span> <span class="kw">=</span> <span class="no">class</span> <span class="kw">==</span> <span class="no">pred</span>) <span class="kw">%&gt;%</span>
  <span class="fu">summarise</span>(<span class="kw">n</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">n</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">percent</span> <span class="kw">=</span> <span class="no">n</span> / <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">n</span>))
<span class="co">#&gt; `summarise()` regrouping output by 'class' (override with `.groups` argument)</span>
<span class="co">#&gt; `summarise()` ungrouping output (override with `.groups` argument)</span>
<span class="co">#&gt; # A tibble: 2 x 3</span>
<span class="co">#&gt;   pred_correct     n percent</span>
<span class="co">#&gt;   &lt;lgl&gt;        &lt;int&gt;   &lt;dbl&gt;</span>
<span class="co">#&gt; 1 FALSE          354   0.702</span>
<span class="co">#&gt; 2 TRUE           150   0.298</span></pre></body></html></div>
<p>Predicting the class based on the cluster is only 31% accurate. Better than random chance (25%), but still not great.</p>
<p>Based on this analysis, I bet the clustering will be more predictive of the class if there are more clusters.</p>
</div>
</div>
<div id="tuning-number-of-clusters" class="section level2">
<h2 class="hasAnchor">
<a href="#tuning-number-of-clusters" class="anchor"></a>Tuning number of clusters</h2>
<p>If you are following along, you may have noticed that clustering takes a long time.</p>
<p>One expensive operation is calculating the distance matrix<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a>. This must be done for every pair of observations. For 500 observations, that’s 124,750 unique pairs<a href="#fn4" class="footnote-ref" id="fnref4"><sup>4</sup></a>.</p>
<p>For each pair, you also need to calculate the dynamic time warping distance, which has a computational complexity of <span class="math inline">\(O(N^2)\)</span><a href="#fn5" class="footnote-ref" id="fnref5"><sup>5</sup></a>.</p>
<p>Fortunately, the <code><a href="https://rdrr.io/pkg/dtwclust/man/tsclust.html">dtwclust::tsclust</a></code> lets you precompute the the similarity matrix and supply that to the cluster algorithms. Care must be taken here to avoid data leakage; make sure the distance matrix is only computed on the training data.</p>
<p>Using the precomputed distance matrix, it’s possible to tune the number of clusters much faster than otherwise (although not necessarily recommended: see the next section).</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">distmat</span> <span class="kw">&lt;-</span> <span class="no">prepped</span>$<span class="no">steps</span><span class="kw">[[</span><span class="fl">1</span>]]$<span class="no">dtwclust</span>$<span class="no">ts</span>@<span class="kw">distmat</span></pre></body></html></div>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">dtw_options</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">control</span> <span class="kw">=</span> <span class="kw pkg">dtwclust</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/dtwclust/man/tsclust-controls.html">partitional_control</a></span>(<span class="kw">distmat</span> <span class="kw">=</span> <span class="no">distmat</span>))

<span class="no">rec</span> <span class="kw">&lt;-</span> <span class="fu">recipe</span>(<span class="no">ethanol</span>, <span class="kw">var</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">ethanol</span>), <span class="kw">roles</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"id"</span>, <span class="st">"outcome"</span>, <span class="st">"input"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/step_dtw.html">step_dtw</a></span>(<span class="no">ts</span>, <span class="kw">k</span> <span class="kw">=</span> <span class="fu">tune</span>(), <span class="kw">options</span> <span class="kw">=</span> <span class="no">dtw_options</span>) <span class="kw">%&gt;%</span>
  <span class="fu">step_mutate_at</span>(<span class="fu">all_predictors</span>(), <span class="kw">fn</span> <span class="kw">=</span> <span class="no">factor</span>)</pre></body></html></div>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">validation_set</span> <span class="kw">&lt;-</span> <span class="fu">tibble</span>(
  <span class="kw">splits</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fu">make_splits</span>(
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">analysis</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="fl">504</span>, <span class="kw">assessment</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="fl">504</span>), <span class="kw">data</span> <span class="kw">=</span> <span class="no">ethanol</span>
  ))
) <span class="kw">%&gt;%</span>
  <span class="fu">new_rset</span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">id</span> <span class="kw">=</span> <span class="st">"validation"</span>), <span class="kw">subclass</span> <span class="kw">=</span> <span class="st">"rset"</span>)</pre></body></html></div>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">tune_results</span> <span class="kw">&lt;-</span> <span class="fu">workflow</span>() <span class="kw">%&gt;%</span>
  <span class="fu">add_model</span>(<span class="fu">multinom_reg</span>() <span class="kw">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"nnet"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">add_recipe</span>(<span class="no">rec</span>) <span class="kw">%&gt;%</span>
  <span class="fu">tune_grid</span>(
    <span class="kw">resamples</span> <span class="kw">=</span> <span class="no">validation_set</span>,
    <span class="kw">grid</span> <span class="kw">=</span> <span class="fu">expand_grid</span>(<span class="kw">k</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">4</span>, <span class="fl">8</span>, <span class="fl">16</span>, <span class="fl">32</span>, <span class="fl">64</span>))
  )</pre></body></html></div>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="no">tune_results</span> <span class="kw">%&gt;%</span>
  <span class="fu">collect_metrics</span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">.metric</span> <span class="kw">==</span> <span class="st">"accuracy"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">select</span>(<span class="no">k</span>, <span class="no">mean</span>)
<span class="co">#&gt; # A tibble: 5 x 2</span>
<span class="co">#&gt;       k  mean</span>
<span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1     4 0.335</span>
<span class="co">#&gt; 2     8 0.333</span>
<span class="co">#&gt; 3    16 0.379</span>
<span class="co">#&gt; 4    32 0.409</span>
<span class="co">#&gt; 5    64 0.472</span></pre></body></html></div>
<p>Increasing the number of clusters does make the feature more useful in predicting the outcome. With too many clusters, the usefulness starts to decrease. There may be more correlation with the class, but you can no longer visualize and understand the characteristics of certain clusters.</p>
<p>If the goal is to simplify increase the classification accuracy, rather than understanding similar groups, there are better and faster ways.</p>
</div>
<div id="alternatives-to-supervised-clustering" class="section level2">
<h2 class="hasAnchor">
<a href="#alternatives-to-supervised-clustering" class="anchor"></a>Alternatives to supervised clustering</h2>
<p>Tuning clusters is not necessarily something I’d recommend. Clustering takes a long time, even if we are using the precomputed distance matrix.</p>
<p>And there are much better options for dimensionality reduction for time series. Predicting the class using 8 discrete cosine transform coefficients is almost as accurate as predicting the class with 64 clusters. 32 coefficients brings the accuracy to 92%. Using <code>step_dct</code> is also significantly faster.</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">rec</span> <span class="kw">&lt;-</span> <span class="fu">recipe</span>(<span class="no">ethanol</span>, <span class="kw">var</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">ethanol</span>), <span class="kw">roles</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"id"</span>, <span class="st">"outcome"</span>, <span class="st">"input"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/step_dct.html">step_dct</a></span>(<span class="no">ts</span>, <span class="kw">k</span> <span class="kw">=</span> <span class="fu">tune</span>())

<span class="no">tune_results</span> <span class="kw">&lt;-</span> <span class="fu">workflow</span>() <span class="kw">%&gt;%</span>
  <span class="fu">add_model</span>(<span class="fu">multinom_reg</span>() <span class="kw">%&gt;%</span> <span class="fu">set_engine</span>(<span class="st">"nnet"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">add_recipe</span>(<span class="no">rec</span>) <span class="kw">%&gt;%</span>
  <span class="fu">tune_grid</span>(
    <span class="kw">resamples</span> <span class="kw">=</span> <span class="no">validation_set</span>,
    <span class="kw">grid</span> <span class="kw">=</span> <span class="fu">expand_grid</span>(<span class="kw">k</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">4</span>, <span class="fl">8</span>, <span class="fl">16</span>, <span class="fl">32</span>, <span class="fl">64</span>))
  )
<span class="co">#&gt; Warning in `[.tbl_df`(x, is.finite(x &lt;- as.numeric(x))): NAs introduced by</span>
<span class="co">#&gt; coercion</span>

<span class="no">tune_results</span> <span class="kw">%&gt;%</span>
  <span class="fu">collect_metrics</span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">.metric</span> <span class="kw">==</span> <span class="st">"accuracy"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">select</span>(<span class="no">k</span>, <span class="no">mean</span>)
<span class="co">#&gt; # A tibble: 5 x 2</span>
<span class="co">#&gt;       k  mean</span>
<span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1     4 0.312</span>
<span class="co">#&gt; 2     8 0.417</span>
<span class="co">#&gt; 3    16 0.792</span>
<span class="co">#&gt; 4    32 0.919</span>
<span class="co">#&gt; 5    64 0.925</span></pre></body></html></div>
</div>
<div id="additional-cluster-options" class="section level2">
<h2 class="hasAnchor">
<a href="#additional-cluster-options" class="anchor"></a>Additional cluster options</h2>
<p>Many clustering techniques and options are available in available in <code><a href="https://rdrr.io/pkg/dtwclust/man/tsclust.html">dtwclust::tsclust</a></code>. I recommend reading the <a href="https://cran.r-project.org/web/packages/dtwclust/vignettes/dtwclust.pdf">documentation</a> if you aren’t satisified with the defaults.</p>
<p>Additionally, <code>step_dtw</code> only allows tuning the number the number of clusters, but if you want more flexibility look into <code><a href="https://rdrr.io/pkg/dtwclust/man/compare_clusterings.html">dtwclust::compare_clusterings</a></code>.</p>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p> You can also cluster time series using the discrete cosine transform coefficients found using <code>step_dct</code>. These features are uncorrelated, so you are free to use traditional distance metrics and clustering techniques.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>I won’t cover clustering statistics here, but the UC Business Analytics Programming Guide <a href="https://uc-r.github.io/kmeans_clustering">series</a> has many examples.<a href="#fnref2" class="footnote-back">↩︎</a></p></li>
<li id="fn3"><p> Also called the dissimilarity matrix.<a href="#fnref3" class="footnote-back">↩︎</a></p></li>
<li id="fn4"><p>500 choose 2<a href="#fnref4" class="footnote-back">↩︎</a></p></li>
<li id="fn5"><p> Some improvements can be made. <code>dtwclust</code> offers <code>dtw_basic</code> by default, which is significantly faster, with fewer features. And the <a href="https://dl.acm.org/doi/10.1145/3230734">theoretical</a> computational complexity is <span class="math inline">\(O(n^2/\log\log(n))\)</span>, although I don’t know if this has been implemented anywhere, or if its technically feasible to do so.<a href="#fnref5" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by First Last.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
